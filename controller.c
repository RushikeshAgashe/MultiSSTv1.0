/*
 * controller.c
 *
 *  Created on: Jul 21, 2018
 *      Author: ragashe
 */
#include "DSP28x_Project.h"
#include "controller.h"
#include "variables.h"
#include "utilities.h"

#define DSP1    1
#define DSP2    2
#define DSP3    3
#define DSP     DSP2

#define MIN(x,y)    (x<y)?x:y

float sin_theta         = 0.0f;
float cos_theta         = 0.0f;
float theta_old_sin     = 0.0f;
float theta_new_sin     = 0.0f;
float theta_old_cos     = 0.5*PI;
float theta_new_cos     = 0.0f;
float inv_delta_theta   = 265.25888f;
unsigned int theta_idx_sin = 0;
unsigned int theta_idx_cos = 0;

float Vgrid             = 0.0f;
float vgrid_alpha       = 0.0f;
float vgrid_beta        = 0.0f;
float vgrid_d           = 0.0f;
float vgrid_q           = 0.0f;
float vgrid_q_ref       = 0.0f;
float vgrid_q_err_new   = 0.0f;
float vgrid_q_err_old   = 0.0f;

float Kp_PLL            = 0.8;                  // Kp value for the SRF PLL
float Ki_PLL            = 300.70;                  // Ki value for the SRF PLL
float w_pll_kp          = 0.0f;                     // Kp*error value for SRF PLL
float w_ff_pll          = 2.0*PI*60.0;           // W(fundamental frequency) feed-forward  = 2*pi*60 for SRF PLL, unit is rad/sec
float w_sat_max         = 2.0*PI*30.0;            // Max saturation value for w(frequency), unit is rad/sec
float w_sat_min         = -2.0*PI*30.0;           // Min saturation value for w(frequency), unit is rad/sec
float Ki_unity          = 1.0f;                     // This value is always 1, as w is getting converted to theta hence only a pure integrator required, for unit vector(sine and cos) generation
float theta_max         = 10.0f;                    // The theta value should never be greater than 2*pi, this is not used as the main code limits the max theta to 2*pi
float theta_min         = -10.0f;                   // The theta value should never be smaller than 0, this is not used as the main code limits the min theta to 0.
float theta_pll_old_cos = 0.5*PI;
float theta_pll_new_cos = 0.0f;
float theta_pll_old_sin = 0.0f;
float theta_pll_new_sin = 0.0f;
float sin_theta_pll     = 0.0f;
float cos_theta_pll     = 0.0f;
unsigned int theta_pll_idx_sin = 0;
unsigned int theta_pll_idx_cos = 0;

float back_cal_val  = 0.0f;                     // Output of the anti-windup scheme (back calculation), (PI(saturated) - PI)*Gain
float back_cal_gain = 1000;                  // Gain for the anti-windup scheme (back calculation)

float w_pll_old     = 0.0f;                     // Old w for the SRF PLL (output of the PI controller)
float w_pll_new     = 0.0f;                     // New w for the SRF PLL (output of the PI controller)
float w_wff_old     = 0.0f;                     // Old w(frequency in rad/sec) with feed-forward value
float w_wff_new     = 0.0f;                     // New w(frequency in rad/sec) with feed-forward value
float w_pll_pi      = 0.0f;                     // Output of the PI controller
float w_pll_pi_sat  = 0.0f;                     // Output of the saturation for the PI controller

const float theta[1669]   = {0,0.003769902,0.007539751,0.011309492,0.015079073,0.01884844,0.022617538,0.026386315,0.030154718,0.033922691,0.037690183,0.041457138,0.045223505,0.048989229,0.052754257,0.056518534,0.060282009,0.064044627,0.067806335,0.071567079,0.075326806,0.079085462,0.082842994,0.086599349,0.090354473,0.094108313,0.097860816,0.101611928,0.105361595,0.109109765,0.112856385,0.1166014,0.120344759,0.124086407,0.127826291,0.131564359,0.135300557,0.139034832,0.142767131,0.146497401,0.150225589,0.153951642,0.157675507,0.161397131,0.165116461,0.168833445,0.172548029,0.17626016,0.179969787,0.183676856,0.187381315,0.19108311,0.19478219,0.198478501,0.202171992,0.205862609,0.2095503,0.213235014,0.216916696,0.220595296,0.224270761,0.227943038,0.231612076,0.235277822,0.238940224,0.242599231,0.246254789,0.249906848,0.253555355,0.257200258,0.260841506,0.264479047,0.268112829,0.271742801,0.27536891,0.278991106,0.282609337,0.286223551,0.289833698,0.293439725,0.297041582,0.300639217,0.304232579,0.307821618,0.311406282,0.31498652,0.318562281,0.322133515,0.325700171,0.329262197,0.332819545,0.336372162,0.339919998,0.343463004,0.347001128,0.35053432,0.354062531,0.357585709,0.361103806,0.36461677,0.368124553,0.371627103,0.375124372,0.37861631,0.382102866,0.385583992,0.389059638,0.392529755,0.395994293,0.399453203,0.402906436,0.406353942,0.409795674,0.413231581,0.416661616,0.420085728,0.423503871,0.426915994,0.43032205,0.433721991,0.437115767,0.44050333,0.443884634,0.447259628,0.450628266,0.4539905,0.457346281,0.460695563,0.464038297,0.467374436,0.470703932,0.474026739,0.477342809,0.480652095,0.483954549,0.487250126,0.490538777,0.493820457,0.497095119,0.500362716,0.503623202,0.50687653,0.510122654,0.513361528,0.516593106,0.519817343,0.523034191,0.526243606,0.529445542,0.532639954,0.535826795,0.539006021,0.542177587,0.545341447,0.548497556,0.551645871,0.554786345,0.557918934,0.561043594,0.564160281,0.567268949,0.570369555,0.573462056,0.576546406,0.579622561,0.58269048,0.585750117,0.588801429,0.591844373,0.594878905,0.597904983,0.600922563,0.603931603,0.60693206,0.609923891,0.612907054,0.615881505,0.618847204,0.621804108,0.624752174,0.627691361,0.630621628,0.633542931,0.636455231,0.639358486,0.642252653,0.645137693,0.648013564,0.650880225,0.653737636,0.656585756,0.659424544,0.66225396,0.665073965,0.667884517,0.670685577,0.673477105,0.676259061,0.679031406,0.681794101,0.684547106,0.687290382,0.69002389,0.692747591,0.695461447,0.698165419,0.700859468,0.703543557,0.706217647,0.708881699,0.711535677,0.714179543,0.716813258,0.719436786,0.722050089,0.72465313,0.727245872,0.729828279,0.732400313,0.734961938,0.737513117,0.740053815,0.742583995,0.745103621,0.747612658,0.75011107,0.75259882,0.755075875,0.757542198,0.759997755,0.762442511,0.764876431,0.76729948,0.769711624,0.772112829,0.77450306,0.776882284,0.779250467,0.781607575,0.783953574,0.786288432,0.788612115,0.79092459,0.793225824,0.795515785,0.79779444,0.800061756,0.802317701,0.804562244,0.806795352,0.809016994,0.811227138,0.813425753,0.815612807,0.817788269,0.819952109,0.822104296,0.824244798,0.826373587,0.82849063,0.830595899,0.832689364,0.834770994,0.83684076,0.838898632,0.840944582,0.842978581,0.845000598,0.847010607,0.849008578,0.850994482,0.852968292,0.854929979,0.856879516,0.858816874,0.860742027,0.862654947,0.864555606,0.866443979,0.868320037,0.870183755,0.872035105,0.873874062,0.875700599,0.87751469,0.87931631,0.881105433,0.882882034,0.884646086,0.886397566,0.888136449,0.889862709,0.891576322,0.893277264,0.89496551,0.896641037,0.89830382,0.899953837,0.901591064,0.903215476,0.904827052,0.906425769,0.908011603,0.909584533,0.911144535,0.912691587,0.914225669,0.915746757,0.91725483,0.918749868,0.920231847,0.921700749,0.92315655,0.924599232,0.926028773,0.927445153,0.928848352,0.930238351,0.931615128,0.932978665,0.934328942,0.935665941,0.936989642,0.938300026,0.939597074,0.940880769,0.942151092,0.943408025,0.944651549,0.945881649,0.947098305,0.948301501,0.949491219,0.950667443,0.951830156,0.952979342,0.954114983,0.955237064,0.956345569,0.957440483,0.958521789,0.959589472,0.960643518,0.961683911,0.962710636,0.963723678,0.964723024,0.96570866,0.96668057,0.967638742,0.968583161,0.969513815,0.97043069,0.971333772,0.97222305,0.973098511,0.973960142,0.97480793,0.975641865,0.976461933,0.977268124,0.978060425,0.978838826,0.979603316,0.980353883,0.981090517,0.981813208,0.982521945,0.983216719,0.983897518,0.984564335,0.985217158,0.985855979,0.986480789,0.987091579,0.987688341,0.988271065,0.988839743,0.989394368,0.989934931,0.990461426,0.990973843,0.991472177,0.99195642,0.992426564,0.992882605,0.993324534,0.993752345,0.994166034,0.994565593,0.994951017,0.995322301,0.995679439,0.996022426,0.996351257,0.996665928,0.996966434,0.997252771,0.997524935,0.997782922,0.998026728,0.99825635,0.998471785,0.998673029,0.99886008,0.999032935,0.999191591,0.999336047,0.999466299,0.999582347,0.999684189,0.999771823,0.999845249,0.999904464,0.999949468,0.999980261,0.999996842,0.99999921,0.999987367,0.999961311,0.999921044,0.999866566,0.999797877,0.999714979,0.999617873,0.99950656,0.999381042,0.999241321,0.999087398,0.998919276,0.998736957,0.998540443,0.998329739,0.998104845,0.997865767,0.997612506,0.997345068,0.997063455,0.996767671,0.996457721,0.996133609,0.99579534,0.995442919,0.99507635,0.994695638,0.99430079,0.993891811,0.993468707,0.993031482,0.992580145,0.992114701,0.991635157,0.99114152,0.990633796,0.990111993,0.989576119,0.98902618,0.988462185,0.987884142,0.987292059,0.986685944,0.986065806,0.985431655,0.984783498,0.984121345,0.983445205,0.982755089,0.982051005,0.981332964,0.980600977,0.979855052,0.979095202,0.978321437,0.977533768,0.976732206,0.975916762,0.975087448,0.974244276,0.973387258,0.972516406,0.971631733,0.97073325,0.969820971,0.968894909,0.967955077,0.967001488,0.966034155,0.965053094,0.964058316,0.963049837,0.962027672,0.960991833,0.959942337,0.958879198,0.957802431,0.956712052,0.955608075,0.954490517,0.953359394,0.952214722,0.951056516,0.949884794,0.948699572,0.947500867,0.946288695,0.945063075,0.943824024,0.942571558,0.941305697,0.940026457,0.938733858,0.937427917,0.936108653,0.934776085,0.933430232,0.932071112,0.930698746,0.929313153,0.927914352,0.926502363,0.925077207,0.923638903,0.922187472,0.920722935,0.919245313,0.917754626,0.916250895,0.914734143,0.91320439,0.911661659,0.910105971,0.908537348,0.906955813,0.905361388,0.903754096,0.902133959,0.900501002,0.898855246,0.897196715,0.895525433,0.893841424,0.892144712,0.89043532,0.888713273,0.886978595,0.885231311,0.883471447,0.881699026,0.879914074,0.878116617,0.87630668,0.874484289,0.872649469,0.870802247,0.868942649,0.867070701,0.865186431,0.863289864,0.861381028,0.859459949,0.857526656,0.855581176,0.853623536,0.851653764,0.849671888,0.847677936,0.845671937,0.843653919,0.841623911,0.839581942,0.83752804,0.835462235,0.833384557,0.831295034,0.829193696,0.827080574,0.824955698,0.822819096,0.820670801,0.818510842,0.816339251,0.814156057,0.811961292,0.809754988,0.807537175,0.805307886,0.803067151,0.800815003,0.798551473,0.796276594,0.793990399,0.791692919,0.789384187,0.787064236,0.7847331,0.782390811,0.780037402,0.777672907,0.77529736,0.772910794,0.770513243,0.768104741,0.765685323,0.763255023,0.760813876,0.758361915,0.755899177,0.753425695,0.750941506,0.748446644,0.745941145,0.743425045,0.740898379,0.738361183,0.735813493,0.733255346,0.730686778,0.728107825,0.725518524,0.722918911,0.720309025,0.717688901,0.715058577,0.712418091,0.70976748,0.707106781,0.704436033,0.701755273,0.69906454,0.696363871,0.693653306,0.690932882,0.688202639,0.685462614,0.682712848,0.679953379,0.677184246,0.674405489,0.671617147,0.66881926,0.666011867,0.663195009,0.660368726,0.657533057,0.654688044,0.651833725,0.648970143,0.646097337,0.643215349,0.64032422,0.63742399,0.634514701,0.631596393,0.62866911,0.625732892,0.62278778,0.619833818,0.616871046,0.613899508,0.610919244,0.607930298,0.604932711,0.601926528,0.598911789,0.595888539,0.59285682,0.589816675,0.586768148,0.583711281,0.580646118,0.577572703,0.57449108,0.571401292,0.568303383,0.565197397,0.562083378,0.558961371,0.555831419,0.552693569,0.549547863,0.546394347,0.543233065,0.540064063,0.536887385,0.533703077,0.530511184,0.527311751,0.524104824,0.520890449,0.51766867,0.514439534,0.511203086,0.507959374,0.504708442,0.501450337,0.498185105,0.494912793,0.491633448,0.488347115,0.485053841,0.481753674,0.47844666,0.475132846,0.47181228,0.468485008,0.465151078,0.461810537,0.458463433,0.455109813,0.451749725,0.448383216,0.445010335,0.441631129,0.438245647,0.434853937,0.431456046,0.428052023,0.424641916,0.421225775,0.417803647,0.414375581,0.410941626,0.40750183,0.404056243,0.400604914,0.397147891,0.393685223,0.390216961,0.386743152,0.383263847,0.379779096,0.376288946,0.372793449,0.369292653,0.365786609,0.362275367,0.358758975,0.355237485,0.351710946,0.348179409,0.344642923,0.341101539,0.337555307,0.334004278,0.330448502,0.32688803,0.323322911,0.319753198,0.31617894,0.312600189,0.309016994,0.305429408,0.301837482,0.298241265,0.29464081,0.291036167,0.287427388,0.283814524,0.280197626,0.276576746,0.272951936,0.269323246,0.265690728,0.262054434,0.258414416,0.254770726,0.251123414,0.247472534,0.243818136,0.240160273,0.236498997,0.23283436,0.229166413,0.22549521,0.221820802,0.218143241,0.21446258,0.210778872,0.207092167,0.203402519,0.199709981,0.196014604,0.192316441,0.188615545,0.184911968,0.181205764,0.177496984,0.173785681,0.170071909,0.166355719,0.162637165,0.1589163,0.155193176,0.151467847,0.147740364,0.144010783,0.140279154,0.136545532,0.132809969,0.129072518,0.125333234,0.121592167,0.117849373,0.114104904,0.110358813,0.106611154,0.10286198,0.099111344,0.095359299,0.091605899,0.087851197,0.084095246,0.0803381,0.076579813,0.072820437,0.069060026,0.065298633,0.061536313,0.057773118,0.054009102,0.050244318,0.04647882,0.042712662,0.038945897,0.035178578,0.031410759,0.027642494,0.023873836,0.020104838,0.016335555,0.01256604,0.008796346,0.005026527,0.001256637,-0.002513271,-0.006283144,-0.010052927,-0.013822567,-0.017592011,-0.021361205,-0.025130095,-0.028898629,-0.032666751,-0.036434409,-0.040201549,-0.043968118,-0.047734062,-0.051499328,-0.055263862,-0.05902761,-0.06279052,-0.066552537,-0.070313608,-0.07407368,-0.077832699,-0.081590612,-0.085347365,-0.089102905,-0.092857179,-0.096610134,-0.100361715,-0.10411187,-0.107860545,-0.111607687,-0.115353243,-0.11909716,-0.122839384,-0.126579862,-0.130318542,-0.134055369,-0.137790291,-0.141523254,-0.145254207,-0.148983094,-0.152709865,-0.156434465,-0.160156842,-0.163876943,-0.167594714,-0.171310104,-0.175023059,-0.178733527,-0.182441454,-0.186146788,-0.189849477,-0.193549468,-0.197246708,-0.200941145,-0.204632726,-0.208321398,-0.21200711,-0.215689809,-0.219369442,-0.223045958,-0.226719303,-0.230389427,-0.234056276,-0.237719798,-0.241379943,-0.245036656,-0.248689887,-0.252339584,-0.255985694,-0.259628166,-0.263266949,-0.266901989,-0.270533237,-0.274160639,-0.277784145,-0.281403704,-0.285019262,-0.288630771,-0.292238177,-0.295841429,-0.299440477,-0.30303527,-0.306625755,-0.310211883,-0.313793602,-0.317370861,-0.32094361,-0.324511797,-0.328075373,-0.331634285,-0.335188485,-0.33873792,-0.342282542,-0.345822299,-0.34935714,-0.352887017,-0.356411879,-0.359931675,-0.363446355,-0.366955871,-0.370460171,-0.373959206,-0.377452926,-0.380941282,-0.384424223,-0.387901702,-0.391373667,-0.39484007,-0.398300861,-0.401755992,-0.405205413,-0.408649075,-0.412086929,-0.415518926,-0.418945018,-0.422365156,-0.425779292,-0.429187375,-0.43258936,-0.435985196,-0.439374836,-0.442758231,-0.446135334,-0.449506096,-0.45287047,-0.456228407,-0.459579861,-0.462924782,-0.466263125,-0.469594841,-0.472919883,-0.476238204,-0.479549756,-0.482854493,-0.486152367,-0.489443332,-0.492727342,-0.496004348,-0.499274305,-0.502537166,-0.505792885,-0.509041416,-0.512282712,-0.515516727,-0.518743416,-0.521962732,-0.52517463,-0.528379064,-0.531575989,-0.534765358,-0.537947128,-0.541121252,-0.544287686,-0.547446384,-0.550597301,-0.553740394,-0.556875616,-0.560002925,-0.563122274,-0.56623362,-0.569336919,-0.572432126,-0.575519197,-0.578598089,-0.581668758,-0.58473116,-0.587785252,-0.59083099,-0.593868332,-0.596897232,-0.59991765,-0.602929542,-0.605932864,-0.608927575,-0.611913632,-0.614890992,-0.617859613,-0.620819453,-0.62377047,-0.626712621,-0.629645866,-0.632570162,-0.635485468,-0.638391742,-0.641288943,-0.64417703,-0.647055962,-0.649925697,-0.652786196,-0.655637417,-0.658479321,-0.661311865,-0.664135011,-0.666948719,-0.669752947,-0.672547657,-0.675332808,-0.678108361,-0.680874277,-0.683630517,-0.68637704,-0.689113808,-0.691840783,-0.694557925,-0.697265196,-0.699962557,-0.70264997,-0.705327397,-0.707994799,-0.71065214,-0.71329938,-0.715936483,-0.718563411,-0.721180126,-0.723786592,-0.726382772,-0.728968627,-0.731544123,-0.734109222,-0.736663887,-0.739208083,-0.741741773,-0.744264921,-0.746777491,-0.749279449,-0.751770757,-0.754251381,-0.756721285,-0.759180435,-0.761628795,-0.76406633,-0.766493007,-0.76890879,-0.771313645,-0.773707538,-0.776090435,-0.778462302,-0.780823105,-0.783172811,-0.785511386,-0.787838798,-0.790155012,-0.792459997,-0.794753719,-0.797036146,-0.799307246,-0.801566985,-0.803815332,-0.806052256,-0.808277723,-0.810491703,-0.812694164,-0.814885075,-0.817064405,-0.819232123,-0.821388197,-0.823532598,-0.825665294,-0.827786256,-0.829895453,-0.831992856,-0.834078434,-0.836152158,-0.838213998,-0.840263925,-0.842301911,-0.844327926,-0.84634194,-0.848343927,-0.850333856,-0.852311701,-0.854277432,-0.856231022,-0.858172443,-0.860101667,-0.862018668,-0.863923417,-0.865815888,-0.867696054,-0.869563888,-0.871419364,-0.873262455,-0.875093135,-0.876911378,-0.878717157,-0.880510449,-0.882291226,-0.884059465,-0.885815138,-0.887558223,-0.889288693,-0.891006524,-0.892711692,-0.894404173,-0.896083943,-0.897750977,-0.899405252,-0.901046744,-0.902675431,-0.904291288,-0.905894294,-0.907484425,-0.909061658,-0.910625972,-0.912177343,-0.913715751,-0.915241173,-0.916753587,-0.918252972,-0.919739306,-0.921212569,-0.92267274,-0.924119797,-0.925553721,-0.92697449,-0.928382085,-0.929776486,-0.931157672,-0.932525625,-0.933880324,-0.935221751,-0.936549887,-0.937864712,-0.939166207,-0.940454356,-0.941729138,-0.942990536,-0.944238532,-0.945473108,-0.946694248,-0.947901932,-0.949096145,-0.950276869,-0.951444087,-0.952597784,-0.953737942,-0.954864545,-0.955977577,-0.957077023,-0.958162867,-0.959235093,-0.960293686,-0.961338631,-0.962369913,-0.963387519,-0.964391432,-0.965381639,-0.966358126,-0.967320879,-0.968269884,-0.969205127,-0.970126596,-0.971034278,-0.971928159,-0.972808227,-0.973674469,-0.974526873,-0.975365427,-0.976190118,-0.977000936,-0.977797869,-0.978580904,-0.979350032,-0.980105242,-0.980846521,-0.981573861,-0.982287251,-0.98298668,-0.983672138,-0.984343617,-0.985001105,-0.985644595,-0.986274077,-0.986889541,-0.987490979,-0.988078383,-0.988651745,-0.989211055,-0.989756307,-0.990287491,-0.990804602,-0.991307631,-0.991796572,-0.992271416,-0.992732159,-0.993178792,-0.993611311,-0.994029707,-0.994433977,-0.994824113,-0.995200111,-0.995561965,-0.995909669,-0.99624322,-0.996562611,-0.99686784,-0.9971589,-0.997435789,-0.997698502,-0.997947036,-0.998181386,-0.99840155,-0.998607525,-0.998799307,-0.998976894,-0.999140283,-0.999289473,-0.99942446,-0.999545243,-0.999651821,-0.999744191,-0.999822352,-0.999886304,-0.999936046,-0.999971576,-0.999992894,-1,-0.999992894,-0.999971576,-0.999936046,-0.999886304,-0.999822352,-0.999744191,-0.999651821,-0.999545243,-0.99942446,-0.999289473,-0.999140283,-0.998976894,-0.998799307,-0.998607525,-0.99840155,-0.998181386,-0.997947036,-0.997698502,-0.997435789,-0.9971589,-0.99686784,-0.996562611,-0.99624322,-0.995909669,-0.995561965,-0.995200111,-0.994824113,-0.994433977,-0.994029707,-0.993611311,-0.993178792,-0.992732159,-0.992271416,-0.991796572,-0.991307631,-0.990804602,-0.990287491,-0.989756307,-0.989211055,-0.988651745,-0.988078383,-0.987490979,-0.986889541,-0.986274077,-0.985644595,-0.985001105,-0.984343617,-0.983672138,-0.98298668,-0.982287251,-0.981573861,-0.980846521,-0.980105242,-0.979350032,-0.978580904,-0.977797869,-0.977000936,-0.976190118,-0.975365427,-0.974526873,-0.973674469,-0.972808227,-0.971928159,-0.971034278,-0.970126596,-0.969205127,-0.968269884,-0.967320879,-0.966358126,-0.965381639,-0.964391432,-0.963387519,-0.962369913,-0.961338631,-0.960293686,-0.959235093,-0.958162867,-0.957077023,-0.955977577,-0.954864545,-0.953737942,-0.952597784,-0.951444087,-0.950276869,-0.949096145,-0.947901932,-0.946694248,-0.945473108,-0.944238532,-0.942990536,-0.941729138,-0.940454356,-0.939166207,-0.937864712,-0.936549887,-0.935221751,-0.933880324,-0.932525625,-0.931157672,-0.929776486,-0.928382085,-0.92697449,-0.925553721,-0.924119797,-0.92267274,-0.921212569,-0.919739306,-0.918252972,-0.916753587,-0.915241173,-0.913715751,-0.912177343,-0.910625972,-0.909061658,-0.907484425,-0.905894294,-0.904291288,-0.902675431,-0.901046744,-0.899405252,-0.897750977,-0.896083943,-0.894404173,-0.892711692,-0.891006524,-0.889288693,-0.887558223,-0.885815138,-0.884059465,-0.882291226,-0.880510449,-0.878717157,-0.876911378,-0.875093135,-0.873262455,-0.871419364,-0.869563888,-0.867696054,-0.865815888,-0.863923417,-0.862018668,-0.860101667,-0.858172443,-0.856231022,-0.854277432,-0.852311701,-0.850333856,-0.848343927,-0.84634194,-0.844327926,-0.842301911,-0.840263925,-0.838213998,-0.836152158,-0.834078434,-0.831992856,-0.829895453,-0.827786256,-0.825665294,-0.823532598,-0.821388197,-0.819232123,-0.817064405,-0.814885075,-0.812694164,-0.810491703,-0.808277723,-0.806052256,-0.803815332,-0.801566985,-0.799307246,-0.797036146,-0.794753719,-0.792459997,-0.790155012,-0.787838798,-0.785511386,-0.783172811,-0.780823105,-0.778462302,-0.776090435,-0.773707538,-0.771313645,-0.76890879,-0.766493007,-0.76406633,-0.761628795,-0.759180435,-0.756721285,-0.754251381,-0.751770757,-0.749279449,-0.746777491,-0.744264921,-0.741741773,-0.739208083,-0.736663887,-0.734109222,-0.731544123,-0.728968627,-0.726382772,-0.723786592,-0.721180126,-0.718563411,-0.715936483,-0.71329938,-0.71065214,-0.707994799,-0.705327397,-0.70264997,-0.699962557,-0.697265196,-0.694557925,-0.691840783,-0.689113808,-0.68637704,-0.683630517,-0.680874277,-0.678108361,-0.675332808,-0.672547657,-0.669752947,-0.666948719,-0.664135011,-0.661311865,-0.658479321,-0.655637417,-0.652786196,-0.649925697,-0.647055962,-0.64417703,-0.641288943,-0.638391742,-0.635485468,-0.632570162,-0.629645866,-0.626712621,-0.62377047,-0.620819453,-0.617859613,-0.614890992,-0.611913632,-0.608927575,-0.605932864,-0.602929542,-0.59991765,-0.596897232,-0.593868332,-0.59083099,-0.587785252,-0.58473116,-0.581668758,-0.578598089,-0.575519197,-0.572432126,-0.569336919,-0.56623362,-0.563122274,-0.560002925,-0.556875616,-0.553740394,-0.550597301,-0.547446384,-0.544287686,-0.541121252,-0.537947128,-0.534765358,-0.531575989,-0.528379064,-0.52517463,-0.521962732,-0.518743416,-0.515516727,-0.512282712,-0.509041416,-0.505792885,-0.502537166,-0.499274305,-0.496004348,-0.492727342,-0.489443332,-0.486152367,-0.482854493,-0.479549756,-0.476238204,-0.472919883,-0.469594841,-0.466263125,-0.462924782,-0.459579861,-0.456228407,-0.45287047,-0.449506096,-0.446135334,-0.442758231,-0.439374836,-0.435985196,-0.43258936,-0.429187375,-0.425779292,-0.422365156,-0.418945018,-0.415518926,-0.412086929,-0.408649075,-0.405205413,-0.401755992,-0.398300861,-0.39484007,-0.391373667,-0.387901702,-0.384424223,-0.380941282,-0.377452926,-0.373959206,-0.370460171,-0.366955871,-0.363446355,-0.359931675,-0.356411879,-0.352887017,-0.34935714,-0.345822299,-0.342282542,-0.33873792,-0.335188485,-0.331634285,-0.328075373,-0.324511797,-0.32094361,-0.317370861,-0.313793602,-0.310211883,-0.306625755,-0.30303527,-0.299440477,-0.295841429,-0.292238177,-0.288630771,-0.285019262,-0.281403704,-0.277784145,-0.274160639,-0.270533237,-0.266901989,-0.263266949,-0.259628166,-0.255985694,-0.252339584,-0.248689887,-0.245036656,-0.241379943,-0.237719798,-0.234056276,-0.230389427,-0.226719303,-0.223045958,-0.219369442,-0.215689809,-0.21200711,-0.208321398,-0.204632726,-0.200941145,-0.197246708,-0.193549468,-0.189849477,-0.186146788,-0.182441454,-0.178733527,-0.175023059,-0.171310104,-0.167594714,-0.163876943,-0.160156842,-0.156434465,-0.152709865,-0.148983094,-0.145254207,-0.141523254,-0.137790291,-0.134055369,-0.130318542,-0.126579862,-0.122839384,-0.11909716,-0.115353243,-0.111607687,-0.107860545,-0.10411187,-0.100361715,-0.096610134,-0.092857179,-0.089102905,-0.085347365,-0.081590612,-0.077832699,-0.07407368,-0.070313608,-0.066552537,-0.06279052,-0.05902761,-0.055263862,-0.051499328,-0.047734062,-0.043968118,-0.040201549,-0.036434409,-0.032666751,-0.028898629,-0.025130095,-0.021361205,-0.017592011,-0.013822567,-0.010052927,-0.006283144,-0.002513271,0.001256637,0.005026527};

void init_PRController_HBridge(){
    PR_C1 = 1 + ((2.0*PI*FGRID)*TS)*((2.0*PI*FGRID)*TS);
    inv_PR_C1 = (1.0/PR_C1);
    PR_C2 = PR_C1*Kp_HBridge + Kr_HBridge*TS;
    PR_C3 = 2*Kp_HBridge + Kr_HBridge*TS;
    PR_C4 = Kp_HBridge;
}

interrupt void controller(void){
    GpioDataRegs.GPATOGGLE.bit.GPIO10 = 1;

    // PI Controller for DRER
    Vbat = ((float)(AdcData[0]-2047.5)*1000)*(0.00048852);
    Vldc = ((float)(AdcData[1]-2047.5)*1000)*(0.00048852);
    Vldc_err[0] = (Vldc_ref - Vldc);
    Vldc_out[0] = Vldc_out[1] + Kp_DRER*(Vldc_err[0] - Vldc_err[1]) + Ki_DRER*Vldc_err[0]*TS;
    Vldc_err[1] = Vldc_err[0];
    Vldc_out[1] = Vldc_out[0];
    EPwm3Regs.CMPA.half.CMPA = Vldc_out[0];

    // PI Controller for DAB
    Vhdc = ((float)(AdcData[2]-2047.5)*1000)*(0.00048852);
    Vhdc_err[0] = (Vhdc_ref - Vhdc);
    Vhdc_out[0] = Vhdc_out[1] + Kp_DAB*(Vhdc_err[0] - Vhdc_err[1]) + Ki_DAB*Vhdc_err[0]*TS;
    Vhdc_err[1] = Vhdc_err[0];
    Vhdc_out[1] = Vhdc_out[0];
    EPwm2Regs.TBPHS.half.TBPHS = MIN(phase_shift_Q + (Vhdc_out[0]*7500*TS),3000);

    //Update theta and generate sin
    theta_new_sin   = forward_euler(theta_old_sin,TS,2*PI*FGRID);
    theta_new_sin   -= (theta_new_sin > 2*PI)?2*PI:0.0f;
    theta_old_sin   = theta_new_sin;
    theta_idx_sin   = (int)fabs(theta_new_sin*inv_delta_theta);
    sin_theta       = theta[theta_idx_sin];

    //Update theta and generate cos
    theta_new_cos   = forward_euler(theta_old_cos,TS,2*PI*FGRID);
    theta_new_cos   -= (theta_new_cos > 2*PI)?2*PI:0.0f;
    theta_old_cos   = theta_new_cos;
    theta_idx_cos   = (int)fabs(theta_new_cos*inv_delta_theta);
    cos_theta       = theta[theta_idx_cos];

    //SOGI Orthogonal Signal Generation
    Vgrid = ((float)(AdcData[3]-2047.5)*1000)*(0.00048852);
    vgrid_alpha = update_sogi_filter_alpha(Vgrid);
    vgrid_beta  = update_sogi_filter_beta(Vgrid);
//    vgrid_alpha = sin_theta;
//    vgrid_beta = cos_theta;

    //Park's Transform for d and q component
    vgrid_d     = parks_transform_d(vgrid_alpha, vgrid_beta, cos_theta_pll, sin_theta_pll);
    vgrid_q     = parks_transform_q(vgrid_alpha, vgrid_beta, cos_theta_pll, sin_theta_pll);

    //PI Controller for SRF- PLL
    vgrid_q_err_new = vgrid_q_ref - vgrid_q;
    w_pll_new       = trapezoidal_rule(w_pll_old, TS, vgrid_q_err_old, vgrid_q_err_new, Ki_PLL, w_sat_max, w_sat_min);
    w_pll_kp        = Kp_PLL*vgrid_q_err_new;
    w_pll_pi        = w_pll_new  + w_pll_kp;
    w_pll_pi_sat    = controller_saturation(w_sat_max, w_sat_min, w_pll_pi);
    w_wff_new       = w_pll_pi_sat + w_ff_pll;

    //Update theta and generate sin for SRF-PLL
    theta_pll_new_sin   = trapezoidal_rule(theta_pll_old_sin, TS, w_wff_old , w_wff_new, Ki_unity, theta_max, theta_min);
    theta_pll_new_sin   -= (theta_pll_new_sin > 2*PI)?2*PI:0.0f;
    theta_pll_old_sin   = theta_pll_new_sin;
    theta_pll_idx_sin   = (int)fabs(theta_pll_new_sin*inv_delta_theta);
    sin_theta_pll       =  theta[theta_pll_idx_sin];

    //Update theta and generate cos for SRF-PLL
    theta_pll_new_cos = trapezoidal_rule(theta_pll_old_cos, TS, w_wff_old , w_wff_new, Ki_unity, theta_max, theta_min);
    theta_pll_new_cos   -= (theta_pll_new_cos > 2*PI)?2*PI:0.0f;
    theta_pll_old_cos   = theta_pll_new_cos;
    theta_pll_idx_cos   = (int)fabs(theta_pll_new_cos*inv_delta_theta);
    cos_theta_pll       =  theta[theta_pll_idx_cos];

    //Update errors
    vgrid_q_err_old     = vgrid_q_err_new;
    w_pll_old           = w_pll_new;
    w_wff_old           = w_wff_new;
    theta_pll_old_sin   = theta_pll_new_sin;
    theta_pll_old_cos   = theta_pll_new_cos;


    // PR Controller for HBridge
    Iinv = ((float)(AdcData[4]-2047.5)*1000)*(0.00048852);
    Iinv = (Iinv < -25.0)?-25.0:Iinv;
    Iinv = (Iinv > 25.0)?25.0:Iinv;
    Iinv_err[0] = Iinv_ref*cos_theta_pll - Iinv;
    Iinv_out[0] = inv_PR_C1*(2*Iinv_out[1] - Iinv_out[2] + Iinv_err[0]*PR_C2 - Iinv_err[1]*PR_C3 + Iinv_err[2]*PR_C4);
    Iinv_err[2] = Iinv_err[1];
    Iinv_err[1] = Iinv_err[0];
    Iinv_out[2] = Iinv_out[1];
    Iinv_out[1] = Iinv_out[0];
    Iinv_out[0] = (Iinv_out[0] < -1.0)?-1.0:Iinv_out[0];
    Iinv_out[0] = (Iinv_out[0] > 1.0)?1.0:Iinv_out[0];
    EPwm4Regs.CMPA.half.CMPA = (Iinv_out[0] +1.0)*0.5*(SYSCLOCKOUT/ISR_FREQ);
    EPwm5Regs.CMPA.half.CMPA = (Iinv_out[0] +1.0)*0.5*(SYSCLOCKOUT/ISR_FREQ);

    // The ADC conversion takes place when counter = CMPA whereas the Interrupt occurs at counter = 0
    // Collecting the ADC results at the end of the ISR implies that we would not spend time waiting for the ISR results.
    #if DSP == DSP1
        AdcData[0] = AdcMirror.ADCRESULT0;
        AdcData[1] = AdcMirror.ADCRESULT1;
        AdcData[2] = AdcMirror.ADCRESULT2;
        AdcData[3] = AdcMirror.ADCRESULT3;
        AdcData[4] = AdcMirror.ADCRESULT4;
    #elif DSP == DSP2
        AdcData[0] = AdcMirror.ADCRESULT5;
        AdcData[1] = AdcMirror.ADCRESULT6;
        AdcData[2] = AdcMirror.ADCRESULT7;
        AdcData[3] = AdcMirror.ADCRESULT8;
        AdcData[4] = AdcMirror.ADCRESULT9;
    #elif DSP == DSP3
        AdcData[0] = AdcMirror.ADCRESULT6;
        AdcData[1] = AdcMirror.ADCRESULT7;
        AdcData[2] = AdcMirror.ADCRESULT8;
    #else
        This text will break compilation if correct DSP is not selected
    #endif
    GpioDataRegs.GPATOGGLE.bit.GPIO10 = 1;
    EPwm1Regs.ETCLR.bit.INT = 1;
    EPwm1Regs.TBCTL.bit.SWFSYNC = 1;
    PieCtrlRegs.PIEACK.all = PIEACK_GROUP3;
}


